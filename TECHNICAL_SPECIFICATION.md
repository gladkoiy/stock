# Техническая спецификация: Система управления акциями

## Обзор проекта

Система предназначена для управления акциями (промо-кампаниями) и связанными с ними статическими файлами. Приложение включает авторизацию пользователей и функционал для создания, просмотра, редактирования и удаления акций, а также управления файлами.

## Архитектура и технический стек

### Backend API
- **Базовый URL**: `https://api.komandor-stock.ru/promo_api/v1/`
- **Аутентификация**: JWT Bearer tokens
- **Формат данных**: JSON
- **Файлы**: Multipart/form-data для загрузки

### Frontend требования
- Современный веб-интерфейс (рекомендуется React/Next.js)
- Адаптивный дизайн
- Поддержка загрузки файлов с drag & drop
- Валидация форм

## Структура экранов и функционал

### 1. Экран авторизации

#### Описание
Страница входа в систему. Регистрация не предусмотрена - доступ только для авторизованных пользователей.

#### Компоненты экрана
- **Форма авторизации**
  - Поле "Имя пользователя" (username) - обязательное
  - Поле "Пароль" (password) - обязательное, маскированное
  - Кнопка "Войти"
  - Индикатор загрузки при отправке запроса
  - Область для отображения ошибок

#### Функционал
- Валидация обязательных полей
- Отправка запроса авторизации
- Сохранение токена доступа
- Редирект на главную страницу при успешной авторизации
- Отображение ошибок при неудачной авторизации

### 2. Главный экран (Dashboard)

#### Описание
Основная страница системы с перечнем акций и инструментами управления.

#### Компоненты экрана
- **Заголовок приложения**
  - Логотип/название системы
  - Кнопка выхода из системы
  - Информация о текущем пользователе

- **Панель действий**
  - Кнопка "Создать акцию"
  - Фильтры:
    - Переключатель "Показать неактивные акции"
    - Поиск по названию
  - Кнопка обновления списка

- **Список акций**
  - Карточки акций с информацией:
    - Название акции
    - Период действия (startDate - endDate)
    - Статус (активная/неактивная)
    - Количество дочерних акций (если есть)
    - Количество файлов
    - Превью логотипа (если загружен)
  - Действия для каждой акции:
    - Кнопка "Редактировать"
    - Кнопка "Удалить"
    - Кнопка "Управление файлами"
    - Кнопка "Создать дочернюю акцию" (для родительских акций)

#### Функционал
- Получение и отображение списка акций
- Фильтрация активных/неактивных акций
- Поиск акций
- Создание новых акций
- Редактирование существующих акций
- Удаление акций (с подтверждением)
- Переход к управлению файлами

### 3. Модальное окно создания/редактирования акции

#### Компоненты
- **Форма акции**
  - Поле "Название" - обязательное, до 255 символов
  - Поле "Дата начала" - обязательное, date-time picker
  - Поле "Дата окончания" - обязательное, date-time picker
  - Переключатель "Активная" - по умолчанию включен
  - Поле "Родительская акция" - выпадающий список (для дочерних акций)
  - Текстовое поле "Правила" - многострочное, необязательное
  - Поле "Плейсхолдер для купонов" - необязательное
- **Кнопки управления**
  - "Сохранить"
  - "Отмена"

#### Функционал
- Валидация полей формы
- Создание новой акции
- Редактирование существующей акции
- Проверка дат (дата окончания должна быть позже даты начала)

### 4. Экран управления файлами акции

#### Описание
Специализированная страница для работы с файлами конкретной акции.

#### Компоненты экрана
- **Заголовок**
  - Название акции
  - Навигационные крошки
  - Кнопка "Назад к списку акций"

- **Панель загрузки файлов**
  - Drag & drop область
  - Кнопка "Выбрать файлы"
  - Выбор типа файла:
    - promotion_image (Изображение акции)
    - partner_image (Изображение партнера)
    - document (Документ)
    - promotion_logo (Логотип акции)
  - Поле "Подпись/описание"
  - Поле "Порядок сортировки"

- **Список файлов по типам**
  - **Изображения акции**
    - Превью изображений
    - Название файла
    - Подпись
    - Порядок сортировки
    - Кнопки действий (редактировать, удалить)
  
  - **Изображения партнеров**
    - Аналогично изображениям акции
  
  - **Документы**
    - Иконка типа документа
    - Название файла
    - Размер файла
    - Дата загрузки
    - Кнопки действий
  
  - **Логотип акции**
    - Одиночное изображение
    - Превью
    - Возможность замены

#### Функционал
- Загрузка файлов с проверкой типа и размера
- Отображение прогресса загрузки
- Редактирование метаданных файлов
- Удаление файлов
- Изменение порядка сортировки файлов
- Предварительный просмотр изображений и документов

## API Endpoints

### Аутентификация

#### POST /auth/jwt/login
Авторизация пользователя

**Запрос:**
```json
{
  "username": "string",
  "password": "string",
  "grant_type": "password"
}
```

**Ответ:**
```json
{
  "access_token": "string",
  "token_type": "bearer"
}
```

**Заголовки:**
- `Content-Type: application/x-www-form-urlencoded`

### Управление акциями

#### GET /promotions
Получение списка акций

**Параметры запроса:**
- `include_inactive` (boolean) - включить неактивные акции
- `parent_id` (uuid) - получить дочерние акции для указанного родителя

**Заголовки:**
- `Authorization: Bearer {token}`

**Ответ:**
```json
[
  {
    "id": "uuid",
    "name": "string",
    "startDate": "2025-08-07T03:43:17.885159",
    "endDate": "2025-08-07T03:43:17.885184",
    "isActive": true,
    "parentId": "uuid|null",
    "rules": "string|null",
    "couponsPlaceholder": "string|null",
    "promotionImages": [StaticFileRead],
    "partnerImages": [StaticFileRead],
    "documents": [StaticFileRead],
    "children": [PromotionChildRead],
    "promotionLogo": StaticFileRead|null,
    "isParent": boolean,
    "isChild": boolean
  }
]
```

#### POST /promotions
Создание новой акции

**Заголовки:**
- `Authorization: Bearer {token}`
- `Content-Type: application/json`

**Тело запроса:**
```json
{
  "name": "string",
  "startDate": "2025-08-07T03:43:17.885159",
  "endDate": "2025-08-07T03:43:17.885184",
  "isActive": true,
  "parentId": "uuid|null",
  "rules": "string|null",
  "couponsPlaceholder": "string|null"
}
```

#### PUT /promotions
Редактирование акции

**Заголовки:**
- `Authorization: Bearer {token}`
- `Content-Type: application/json`

**Тело запроса:**
```json
{
  "id": "uuid",
  "name": "string",
  "startDate": "2025-08-07T03:43:17.885159",
  "endDate": "2025-08-07T03:43:17.885184",
  "isActive": true,
  "parentId": "uuid|null",
  "rules": "string|null",
  "couponsPlaceholder": "string|null"
}
```

#### DELETE /promotions/{promotion_id}
Удаление акции

**Заголовки:**
- `Authorization: Bearer {token}`

### Управление файлами

#### POST /static/upload/single
Загрузка файла

**Заголовки:**
- `Authorization: Bearer {token}`
- `Content-Type: multipart/form-data`

**Тело запроса (form-data):**
- `file` (binary) - файл для загрузки
- `promotion_id` (uuid) - ID акции
- `file_type` (enum) - тип файла: promotion_image, partner_image, document, promotion_logo
- `caption` (string, optional) - подпись к файлу
- `order` (integer, optional) - порядок сортировки

#### PUT /static/update/single
Обновление метаданных файла

**Заголовки:**
- `Authorization: Bearer {token}`
- `Content-Type: multipart/form-data`

**Тело запроса (form-data):**
- Аналогично POST /static/upload/single

#### DELETE /static/files/{file_id}
Удаление конкретного файла

**Заголовки:**
- `Authorization: Bearer {token}`

#### DELETE /static
Удаление нескольких файлов

**Заголовки:**
- `Authorization: Bearer {token}`
- `Content-Type: application/json`

**Тело запроса:**
```json
{
  "file_ids": ["uuid1", "uuid2", "..."]
}
```

#### GET /static/{promotion_id}/{file_type}/{file_name}
Получение файла по параметрам

## Модели данных

### PromotionRead
```typescript
interface PromotionRead {
  id: string; // UUID
  name: string; // 1-255 символов
  startDate: string; // ISO date-time
  endDate: string; // ISO date-time
  isActive: boolean;
  parentId: string | null; // UUID
  rules: string | null;
  couponsPlaceholder: string | null;
  promotionImages: StaticFileRead[];
  partnerImages: StaticFileRead[];
  documents: StaticFileRead[];
  children: PromotionChildRead[];
  promotionLogo: StaticFileRead | null;
  isParent: boolean; // read-only
  isChild: boolean; // read-only
}
```

### StaticFileRead
```typescript
interface StaticFileRead {
  file_type: StaticFileType | null;
  is_active: boolean;
  caption: string | null;
  promotion_id: string | null; // UUID
  order: number | null;
  file_path: string;
  filename: string | null;
}

enum StaticFileType {
  promotion_image = "promotion_image",
  partner_image = "partner_image", 
  document = "document",
  promotion_logo = "promotion_logo"
}
```

### BearerResponse
```typescript
interface BearerResponse {
  access_token: string;
  token_type: string;
}
```

## Пользовательские сценарии (User Flows)

### 1. Вход в систему
1. Пользователь открывает приложение
2. Отображается страница авторизации
3. Пользователь вводит логин и пароль
4. Система валидирует данные
5. При успешной авторизации перенаправляет на главную страницу
6. При ошибке показывает сообщение об ошибке

### 2. Просмотр списка акций
1. На главной странице загружается список активных акций
2. Пользователь может переключить фильтр для показа неактивных
3. Список обновляется согласно выбранным фильтрам
4. Отображается информация по каждой акции

### 3. Создание новой акции
1. Пользователь нажимает "Создать акцию"
2. Открывается модальное окно с формой
3. Пользователь заполняет обязательные поля
4. При нажатии "Сохранить" происходит валидация
5. Данные отправляются на сервер
6. При успехе модальное окно закрывается, список акций обновляется
7. При ошибке отображается сообщение об ошибке

### 4. Управление файлами акции
1. Пользователь нажимает "Управление файлами" у акции
2. Открывается страница файлов акции
3. Отображаются существующие файлы, сгруппированные по типам
4. Пользователь может загрузить новые файлы:
   - Выбирает тип файла
   - Загружает файл через drag & drop или выбор
   - Заполняет дополнительную информацию
   - Нажимает "Загрузить"
5. Файл загружается с отображением прогресса
6. Список файлов обновляется

### 5. Удаление акции
1. Пользователь нажимает "Удалить" у акции
2. Отображается диалог подтверждения
3. При подтверждении акция удаляется
4. Список акций обновляется

## Требования к UI/UX

### Общие принципы
- **Простота и интуитивность**: Интерфейс должен быть понятен без обучения
- **Отзывчивость**: Все действия должны сопровождаться визуальным фидбеком
- **Доступность**: Соответствие базовым принципам веб-доступности
- **Мобильная адаптивность**: Корректное отображение на различных устройствах

### Цветовая схема
- Основные цвета: синий для активных элементов, серый для вторичных
- Цвета состояний: зеленый (успех), красный (ошибка), оранжевый (предупреждение)
- Нейтральная палитра для текста и фонов

### Типографика
- Четкие, читаемые шрифты
- Иерархия заголовков
- Контрастный текст

### Компоненты интерфейса
- **Кнопки**: Ясно выражают действие, имеют состояния hover/active/disabled
- **Формы**: Ясные лейблы, валидация в реальном времени, понятные сообщения об ошибках
- **Модальные окна**: Не блокируют работу на долгое время, легко закрываются
- **Загрузка**: Индикаторы прогресса для всех асинхронных операций

### Состояния загрузки и ошибок
- **Скелеты загрузки**: Для списков и карточек контента
- **Спиннеры**: Для кнопок и коротких операций  
- **Сообщения об ошибках**: Конструктивные, с предложением действий
- **Пустые состояния**: Информативные заглушки когда нет данных

## Технические требования

### Производительность
- Время загрузки страниц не более 3 секунд
- Плавная анимация (60 FPS)
- Оптимизация изображений
- Ленивая загрузка для списков

### Безопасность
- Хранение JWT токенов в httpOnly cookies (рекомендуется) или localStorage
- Автоматическое обновление токенов
- Валидация данных на клиенте и сервере
- Защита от XSS и CSRF атак

### Совместимость
- Современные браузеры (Chrome 90+, Firefox 88+, Safari 14+, Edge 90+)
- Мобильные браузеры
- Поддержка touch-событий

### Обработка ошибок
- Централизованная система обработки ошибок API
- Информативные сообщения пользователю
- Логирование ошибок для отладки
- Graceful degradation при недоступности API

### Файлы
- Поддерживаемые форматы: изображения (JPEG, PNG, GIF, WebP), документы (PDF, DOC, DOCX)
- Максимальный размер файла: 10 MB
- Прогресс-бар при загрузке
- Предварительный просмотр изображений

## Ограничения и особенности

### API ограничения
- Аутентификация обязательна для всех операций кроме логина
- Токены имеют время жизни (требуется обновление)
- Rate limiting может применяться сервером

### Бизнес-правила
- Дочерние акции не могут иметь собственных детей (только 2 уровня вложенности)
- Название акции обязательно и уникально
- Даты акции должны быть корректными (окончание позже начала)
- Логотип акции может быть только один

### Технические ограничения
- Размер загружаемых файлов
- Форматы поддерживаемых файлов
- Количество одновременных загрузок

## План реализации

### Этап 1: Базовая функциональность
1. Настройка проекта и зависимостей
2. Реализация авторизации
3. Создание главной страницы со списком акций
4. Базовые CRUD операции для акций

### Этап 2: Управление файлами
1. Страница управления файлами
2. Загрузка файлов
3. Отображение и удаление файлов
4. Редактирование метаданных файлов

### Этап 3: Улучшения UX
1. Drag & drop для файлов
2. Предварительный просмотр
3. Анимации и переходы
4. Оптимизация производительности

### Этап 4: Тестирование и оптимизация
1. Unit тесты для компонентов
2. E2E тестирование основных сценариев
3. Оптимизация производительности
4. Исправление багов

## Заключение

Данная спецификация описывает полнофункциональную систему управления акциями с интуитивно понятным интерфейсом. Приложение должно обеспечивать эффективную работу с акциями и файлами, предоставляя пользователям все необходимые инструменты для управления промо-кампаниями.

При реализации следует уделить особое внимание пользовательскому опыту, производительности и безопасности системы.